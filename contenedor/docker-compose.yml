services:
  # --- KEYCLOAK (Identidad y Seguridad) ---
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.3
    container_name: keycloak
    command: start-dev
    ports:
      - "8081:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin123
      - KC_HOSTNAME=localhost
      - KC_HOSTNAME_PORT=8081
      - KC_HOSTNAME_STRICT_BACKCHANNEL=false
      - KC_HTTP_ENABLED=true
    volumes:
      - keycloak_data:/opt/keycloak/data

  # --- BASE DE DATOS (PostgreSQL) ---
  postgres:
    image: postgres:15
    container_name: postgres-db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=mi_usuario
      - POSTGRES_PASSWORD=tpi123
      # Crea las 3 bases de datos al inicio
      - POSTGRES_MULTIPLE_DATABASES=db_cliente,db_flota,db_seguimiento
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./create-multiple-postgresql-databases.sh:/docker-entrypoint-initdb.d/create-multiple-postgresql-databases.sh

  # --- API GATEWAY ---
  api-gateway:
    build:
      context: ./api-gateway # Este suele mantener el guion (según tus archivos anteriores)
    container_name: api-gateway
    ports:
      - "8080:8080"
    depends_on:
      - keycloak
      - microservicio-cliente
      - microservicio-flota
      - microservicio-seguimiento
    environment:
      - spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8081/realms/tpi-backend
      - spring.security.oauth2.resourceserver.jwt.jwk-set-uri=http://keycloak:8080/realms/tpi-backend/protocol/openid-connect/certs
      - server.port=8080
      # Rutas
      - spring.cloud.gateway.routes[0].id=microservicio-cliente
      - spring.cloud.gateway.routes[0].uri=http://microservicio-cliente:8085
      - spring.cloud.gateway.routes[0].predicates[0]=Path=/api/cliente/**
      - spring.cloud.gateway.routes[1].id=microservicio-seguimiento
      - spring.cloud.gateway.routes[1].uri=http://microservicio-seguimiento:8083
      - spring.cloud.gateway.routes[1].predicates[0]=Path=/api/seguimiento/**
      - spring.cloud.gateway.routes[2].id=microservicio-flota
      - spring.cloud.gateway.routes[2].uri=http://microservicio-flota:8084
      - spring.cloud.gateway.routes[2].predicates[0]=Path=/api/flota/**
      - spring.cloud.compatibility-verifier.enabled=false

  # --- MICROSERVICIOS DE NEGOCIO ---
  
  microservicio-cliente:
    build:
      context: ./microserviciocliente # <--- CORREGIDO: Nombre de carpeta SIN guion
    container_name: microservicio-cliente # <--- MANTENIDO: Nombre de red CON guion (para que funcione IntegrationService)
    depends_on:
      - postgres
      - keycloak
    environment:
      - spring.datasource.url=jdbc:postgresql://postgres-db:5432/db_cliente
      - spring.datasource.username=mi_usuario
      - spring.datasource.password=tpi123
      - spring.jpa.hibernate.ddl-auto=validate
      - spring.flyway.enabled=true
      - spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8081/realms/tpi-backend
      - spring.security.oauth2.resourceserver.jwt.jwk-set-uri=http://keycloak:8080/realms/tpi-backend/protocol/openid-connect/certs
      - server.port=8085

  microservicio-flota:
    build:
      context: ./microservicioflota # <--- CORREGIDO: Nombre de carpeta SIN guion
    container_name: microservicio-flota
    depends_on:
      - postgres
      - keycloak
    environment:
      - spring.datasource.url=jdbc:postgresql://postgres-db:5432/db_flota
      - spring.datasource.username=mi_usuario
      - spring.datasource.password=tpi123
      - spring.jpa.hibernate.ddl-auto=validate
      - spring.flyway.enabled=true
      - spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8081/realms/tpi-backend
      - spring.security.oauth2.resourceserver.jwt.jwk-set-uri=http://keycloak:8080/realms/tpi-backend/protocol/openid-connect/certs
      - server.port=8084

  microservicio-seguimiento:
    build:
      context: ./microservicioseguimiento # <--- CORREGIDO: Nombre de carpeta SIN guion
    container_name: microservicio-seguimiento
    depends_on:
      - postgres
      - keycloak
    environment:
      - spring.datasource.url=jdbc:postgresql://postgres-db:5432/db_seguimiento
      - spring.datasource.username=mi_usuario
      - spring.datasource.password=tpi123
      - spring.jpa.hibernate.ddl-auto=validate
      - spring.flyway.enabled=true
      - spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8081/realms/tpi-backend
      - spring.security.oauth2.resourceserver.jwt.jwk-set-uri=http://keycloak:8080/realms/tpi-backend/protocol/openid-connect/certs
      - server.port=8083
      # Variables para comunicación entre microservicios
      - app.ms-cliente.url=http://microservicio-cliente:8085/api/cliente
      - app.ms-flota.url=http://microservicio-flota:8084/api/flota

volumes:
  keycloak_data:
  postgres_data: